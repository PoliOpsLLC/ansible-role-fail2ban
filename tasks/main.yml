---

# Tasks file for fail2ban

- name: 'Load the OS specific varibles'
  include_vars: "{{ role_path }}/vars/{{ ansible_os_family | lower }}.yml"
  tags:
    - 'fail2ban::role'
    - 'fail2ban::install'


- include: 'install_debian.yml'
  when: "{{ ansible_os_family == 'Debian' }}"
  tags:
    - 'fail2ban::role'
    - 'fail2ban::install'


- name: 'Update configuration file - /etc/fail2ban/fail2ban.conf'
  become: True
  template:
    src: "{{ role_path }}/templates/fail2ban.conf.j2"
    dest: '/etc/fail2ban/fail2ban.conf'
    owner: 'root'
    group: 'root'
    mode: '0644'
  notify: 'Restart fail2ban'
  tags:
    - 'fail2ban::role'
    - 'fail2ban::config'


- name: 'Update configuration file - /etc/fail2ban/jail.local'
  become: True
  template:
    src: "{{ role_path }}/templates/jail.local.j2"
    dest: '/etc/fail2ban/jail.local'
    owner: 'root'
    group: 'root'
    mode: '0644'
  notify: 'Restart fail2ban'
  tags:
    - 'fail2ban::role'
    - 'fail2ban::config'


- name: 'Start and enable service'
  become: True
  service:
    name: "{{ fail2ban_service_name }}"
    state: "{{ fail2ban_service_state }}"
    enabled: "{{ fail2ban_service_enabled }}"
  tags:
    - 'fail2ban::role'
    - 'fail2ban::install'
